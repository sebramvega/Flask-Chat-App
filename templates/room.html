{% extends 'base.html' %}
{% block content %}
<!--
  Chat room:
  - Messages pane with sticky composer
  - Presence list + typing indicator
  - Deep link copy + downloadable JSON log
-->
<div class="message-box">
  <h2>
    Chat Room: {{ code }}
    <button id="copy-link" class="mini-btn" title="Copy join link">Copy link</button>
  </h2>

  <!-- Presence + Typing indicators -->
  <div class="muted" id="presence"></div>
  <div class="muted" id="typing"></div>

  <!-- Current user for "me" bubble alignment -->
  <div class="messages" id="messages" data-user='{{ (name or "")|tojson }}'></div>

  <!-- Initial history: safe, parse-only JSON block -->
  <script id="history" type="application/json">
    {{ messages|tojson }}
  </script>

  <div class="inputs">
    <input type="text" placeholder="Message" name="message" id="message" />
    <button type="button" id="send-btn">Send</button>
    <button type="button" id="download-log">Download Log</button>
  </div>
</div>

<script>
  // --- Client bootstrap ------------------------------------------------------
  const socketio = io();
  const messagesEl = document.getElementById("messages");
  const inputEl = document.getElementById("message");
  const sendBtn = document.getElementById("send-btn");
  const presenceEl = document.getElementById("presence");
  const typingEl = document.getElementById("typing");
  const copyBtn = document.getElementById("copy-link");
  const downloadBtn = document.getElementById("download-log");

  const CURRENT_USER = JSON.parse(messagesEl.dataset.user || '""');
  const HISTORY = JSON.parse(document.getElementById("history").textContent || "[]");
  const ALL = [...HISTORY]; // running log (history + live)

  // Escape helper to prevent accidental HTML injection in message text
  const esc = (s) => String(s)
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");

  // Render a single message bubble and autoscroll
  const createMessage = (name, msg) => {
    const who = name === CURRENT_USER ? "me" : (name === "System" ? "system" : "other");
    const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    const html = `
      <div class="msg ${who}">
        <div class="meta">${esc(name)} • <span class="muted">${time}</span></div>
        <div class="bubble">${esc(msg)}</div>
      </div>`;
    messagesEl.insertAdjacentHTML("beforeend", html);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  };

  // Initial history
  HISTORY.forEach(m => createMessage(m.name, m.message));

  // Live updates
  socketio.on("message", (data) => {
    ALL.push(data);
    createMessage(data.name, data.message);
    typingEl.textContent = "";
  });

  // Presence list
  socketio.on("presence", (data) => {
    const who = data.users.map(u => `<code>${esc(u)}</code>`).join(" ");
    presenceEl.innerHTML = `Online (${data.count}): ${who || '—'}`;
  });

  // Typing indicator
  socketio.on("typing", (data) => {
    typingEl.textContent = `${data.name} is typing…`;
    clearTimeout(window.__typingTimer);
    window.__typingTimer = setTimeout(() => typingEl.textContent = "", 1200);
  });

  // Send helpers + simple client cooldown
  let blocked = false;
  function sendMessage() {
    if (blocked) return;
    const v = inputEl.value.trim();
    if (!v) return;
    blocked = true;
    socketio.emit("message", { data: v });
    inputEl.value = "";
    inputEl.focus();
    setTimeout(() => blocked = false, 500);
  }
  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });
  sendBtn.addEventListener("click", sendMessage);

  // Emit typing while composing (rate-limited)
  let lastTyping = 0;
  inputEl.addEventListener("input", () => {
    const now = Date.now();
    if (now - lastTyping > 500) {
      socketio.emit("typing", {});
      lastTyping = now;
    }
  });

  // Copy deep link
  copyBtn.addEventListener("click", async () => {
    const url = `${location.origin}/r/{{ code }}`;
    await navigator.clipboard.writeText(url);
    alert("Room link copied!");
  });

  // Download log (JSON)
  downloadBtn.addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(ALL, null, 2)], {type: "application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `room-{{ code }}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });
</script>
{% endblock %}
